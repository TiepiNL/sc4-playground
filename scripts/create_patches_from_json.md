# create_patches_from_json.py

## Overview

This script generates SimCity 4 exemplar patch files that modify Maxis LotConfiguration exemplars to block RCI (Residential, Commercial, Industrial) development by setting MinSlope to 89.0 degrees, making lots unbuildable.

## Purpose

The sc4-resource-loading-hooks system allows runtime modification of game exemplars through "exemplar patches". This script creates Cohort files that target specific Maxis lots and make them too steep to build on, effectively preventing automatic RCI growth while preserving custom lots and special buildings.

## Input/Output

- **Input**: `data/lot_configurations.json` (generated by `extract_maxis_lots.py`)
- **Output**: Multiple `.dat` patch files in `output_patches/` directory

## Core Logic

### 1. Data Processing

The script reads the JSON file containing extracted Maxis lot data and processes each lot configuration:

```python
# Key properties used for filtering and grouping:
- ZoneTypes: Determines if lot is valid for patching
- ZonePurpose: Used for grouping (R/CS/CO/I-*)  
- ZoneWealth: Used for grouping ($/$$/$$$)
- Instance ID: Target for the patch
```

### 2. Intelligent Filtering

**ZoneTypes Exclusions** (prevents targeting special buildings):
- `null`: Incomplete lot definitions
- `0x0A (10)`: Military zones  
- `0x0B (11)`: Airport zones
- `0x0C (12)`: Seaport zones
- `0x0D (13)`: Spaceport zones
- `0x0E (14)`: Landmark zones
- `0x0F (15)`: Civic/Plopped buildings

**Requirements**:
- Must have valid ZonePurpose (not null)
- Must have valid ZoneWealth (not null)
- Must have valid Instance ID

### 3. Logical Grouping

Lots are grouped by **ZonePurpose + ZoneWealth** combinations to create organized, manageable patch files:

| Group | ZonePurpose | ZoneWealth | Description |
|-------|-------------|------------|-------------|
| R$ | 1 | 1 | Low wealth residential |
| R$$ | 1 | 2 | Medium wealth residential |
| R$$$ | 1 | 3 | High wealth residential |
| CS$ | 2 | 1 | Low wealth commercial services |
| CS$$ | 2 | 2 | Medium wealth commercial services |
| CS$$$ | 2 | 3 | High wealth commercial services |
| CO$$ | 3 | 2 | Medium wealth commercial office |
| CO$$$ | 3 | 3 | High wealth commercial office |
| I-r$ | 5 | 1 | Raw materials industrial |
| I-d$$ | 6 | 2 | Dirty industrial |
| I-m$$ | 7 | 2 | Manufacturing industrial |
| I-ht$$$ | 8 | 3 | High-tech industrial |

### 4. DBPF File Structure

Each generated `.dat` file follows the DBPF (Database Packed File) format:

```
[96-byte DBPF Header]
[CQZB Cohort Exemplar Data]
[20-byte File Index Table]
```

### 5. Cohort Exemplar Format

The exemplar data uses the CQZB (Cohort Query Z B) format required for exemplar patches:

```
CQZB Header (20 bytes):
- Magic: "CQZB1###" 
- Reserved: 12 zero bytes

Property Count: 2

Property 1 - ExemplarPatchTargets (0x0062E78A):
- Type Info: 00 03 80 00
- Padding Byte: 00
- Array Length: number_of_targets × 2
- Data: Alternating Group ID (0xA8FBD372) and Instance ID pairs

Property 2 - MinSlope (0x699B08A4):  
- Type Info: 00 09 80 00
- Padding Byte: 00
- Array Length: 1
- Data: 89.0 (float32)
```

## Key Technical Details

### Padding Byte Requirement

The script includes a critical padding byte after each property's type info. This byte is essential for proper parsing by SC4 tools:

```python
cohort_data.extend(struct.pack('<BBBB', 0x00, 0x03, 0x80, 0x00))  # Type info
cohort_data.extend(struct.pack('<B', 0x00))  # REQUIRED padding byte
cohort_data.extend(struct.pack('<I', num_target_values))  # Array length
```

### Instance ID Generation

Patch files use sequential Instance IDs starting from `0xFE7CD975`:

```python
STARTING_INSTANCE_ID = 0xFE7CD975  # Configurable via environment variable
current_instance_id = STARTING_INSTANCE_ID
# Each patch file gets: current_instance_id++
```

### Group ID Constants

All LotConfiguration exemplars use the same Group ID:

```python
LOT_CONFIG_GROUP_ID = 0xA8FBD372  # Standard for all lots
PATCH_COHORT_GROUP_ID = 0xb03697d1  # Required by sc4-resource-loading-hooks
```

## Usage

### Basic Execution
```bash
python scripts/create_patches_from_json.py
```

### Environment Variables
```bash
# Customize starting Instance ID
set STARTING_INSTANCE_ID=0x12345678
python scripts/create_patches_from_json.py
```

## Output Files

The script generates 12 patch files covering all RCI combinations:

```
stop_maxis_growable_R$.dat      (105 targets)
stop_maxis_growable_R$$.dat     (101 targets)  
stop_maxis_growable_R$$$.dat    (95 targets)
stop_maxis_growable_CS$.dat     (144 targets)
stop_maxis_growable_CS$$.dat    (238 targets)
stop_maxis_growable_CS$$$.dat   (201 targets)
stop_maxis_growable_CO$$.dat    (291 targets)
stop_maxis_growable_CO$$$.dat   (278 targets)
stop_maxis_growable_I-r$.dat    (31 targets)
stop_maxis_growable_I-d$$.dat   (89 targets)
stop_maxis_growable_I-m$$.dat   (90 targets)
stop_maxis_growable_I-ht$$$.dat (71 targets)
```

**Total Coverage**: 1,734 Maxis lots (91% of all lots, excluding special buildings)

## Installation

1. Copy all `.dat` files to your SimCity 4 Plugins folder
2. Ensure `sc4-resource-loading-hooks.dll` is in your Plugins folder
3. Launch SimCity 4

## Effect

- Targeted Maxis lots become unbuildable due to MinSlope=89.0°
- Custom lots and BATs remain unaffected
- Special buildings (landmarks, airports, etc.) remain functional
- Player can still manually place lots if desired

## Dependencies

- **sc4-resource-loading-hooks**: Required for exemplar patching system
- **Input Data**: `lot_configurations.json` from `extract_maxis_lots.py`
- **Python**: Standard library only (struct, json, os, time)

## Error Handling

The script includes comprehensive error handling for:

- Missing input files
- Invalid JSON format  
- Malformed lot data
- File system operations
- Instance ID conversion errors

## Validation

Use the included validation tools to verify generated files:

```bash
python scripts/debug/validate_patches.py    # Validate all patch files
python scripts/debug/dbpf_parser.py <file>  # Examine specific file structure
```

## Compatibility

- **SimCity 4**: All versions with sc4-resource-loading-hooks
- **Tools**: Compatible with iLives Reader, SC4Tool, and other DBPF editors
- **Mods**: Works alongside other exemplar modifications
